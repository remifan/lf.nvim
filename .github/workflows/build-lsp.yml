name: Build LF LSP Server

on:
  workflow_dispatch:
    inputs:
      lf_version:
        description: "Lingua Franca release tag (e.g. v0.11.0)"
        required: true
        type: string

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout lingua-franca at release tag
        uses: actions/checkout@v4
        with:
          repository: lf-lang/lingua-franca
          ref: ${{ inputs.lf_version }}
          submodules: recursive

      - name: Set up Java 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17

      - name: Build LSP shadow jar
        run: ./gradlew :lsp:shadowJar

      - name: Identify built jar
        id: jar
        run: |
          jar=$(ls lsp/build/libs/lsp-*-all.jar)
          echo "path=$jar" >> "$GITHUB_OUTPUT"
          echo "name=$(basename "$jar")" >> "$GITHUB_OUTPUT"

      - name: Create release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          tag="lsp-${{ inputs.lf_version }}"
          gh release create "$tag" \
            --repo "${{ github.repository }}" \
            --title "LSP Server (Lingua Franca ${{ inputs.lf_version }})" \
            --notes "Pre-built LSP server jar from [lf-lang/lingua-franca ${{ inputs.lf_version }}](https://github.com/lf-lang/lingua-franca/releases/tag/${{ inputs.lf_version }}).

          Built from source under the BSD 2-Clause License. See [LICENSE](https://github.com/lf-lang/lingua-franca/blob/${{ inputs.lf_version }}/LICENSE.md).

          ## Usage
          Download the jar and point \`LF_LSP_JAR\` to it:
          \`\`\`bash
          export LF_LSP_JAR=/path/to/${{ steps.jar.outputs.name }}
          \`\`\`" \
            "${{ steps.jar.outputs.path }}"
